<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.keanu_coffee.transport.mapper.DispatchMapper">
	<!-- 첨부파일(FILE) 테이블 ResultMap -->
	<resultMap id="FileResultMap" type="FileDTO">
		<id property="fileIdx" column="file_idx" /> 
		<result property="targetTable" column="target_table" />
		<result property="targetTableIdx" column="target_table_idx" />
		<result property="originalFileName" column="original_file_name" />
		<result property="realFileName" column="real_file_name" />
		<result property="subDir" column="sub_dir" />
		<result property="fileSize" column="file_size" />
		<result property="contentType" column="content_type" />
		<result property="createdAt" column="file_created_at" />
		<result property="updatedAt" column="file_updated_at" />
	</resultMap>

	<!-- 배차 카운트 -->
	<select id="selectDispatchCount" resultType="int">
		SELECT
			COUNT(dispatch_idx)
		FROM
			V_DISPATCH_DETAIL
		WHERE
			1 = 1
			<if test="filter != null and filter != '전체'">
			AND
				status = #{filter}
			</if>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND 
					(region_name LIKE CONCAT ('%', #{searchKeyword}, '%')
				OR
					driver_name LIKE CONCAT ('%', #{searchKeyword}, '%')
				OR 
					vehicle_number LIKE CONCAT ('%', #{searchKeyword}, '%'))
			</if>
	</select>
	
	<!-- 배차 리스트 -->
	<select id="selectAllDispatch" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_DISPATCH_DETAIL
		WHERE
			1 = 1
			<if test="filter != null and filter != '전체'">
			AND
				status = #{filter}
			</if>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND 
					(region_name LIKE CONCAT ('%', #{searchKeyword}, '%')
				OR
					driver_name LIKE CONCAT ('%', #{searchKeyword}, '%')
				OR 
					vehicle_number LIKE CONCAT ('%', #{searchKeyword}, '%'))
			</if>
		ORDER BY 
			dispatch_date DESC
			, start_slot ASC
		LIMIT
			#{startRow}     
			, #{listLimit} 
	</select>
	
	<!-- 배차 목록 (현재 날짜 기준) -->
	<select id="selectAllDispatchByToday" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_DISPATCH_DETAIL
		WHERE
			DATE(dispatch_date) = CURRENT_DATE
	</select>

	<!-- 배차 요청 리스트 -->
	<select id="selectDispatchList" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_OUTBOUND_REGION_GROUP
		ORDER BY
			dispatch_date DESC
	</select>
	
	<!-- 배차 등록 -->
	<insert id="insertDispatch" useGeneratedKeys="true" keyProperty="dispatchIdx">
		INSERT INTO DISPATCH (
			dispatch_date
	        , start_slot
	        , region_idx
	        , created_at
	        , status
	        , urgent
	        , requires_additional
		)
		VALUES (
			#{dispatchDate}
			, #{startSlot}
			, #{regionIdx}
			, NOW()
			, #{status}
			, #{urgent}
			, #{requiresAdditional}
		)
	</insert>
	
	<!-- 배차 배정 테이블 등록 -->
	<insert id="insertDispatchAssignment">
		INSERT INTO DISPATCH_ASSIGNMENT (
			dispatch_idx
			, driver_idx
			, vehicle_idx
			, status
			, created_at
		)
		VALUES (
			#{dispatchIdx}
			, #{empIdx}
			, #{vehicleIdx}
			, #{status}
			, NOW()
		)
	</insert>
	
	<!-- 배차 매핑 테이블 등록 -->
	<insert id="insertDispatchOrderMap">
		INSERT INTO DISPATCH_ORDER_MAP (
			dispatch_idx
			, outbound_order_idx
			, created_at
		)
		VALUES (
			#{dispatchIdx}
			, #{outboundOrderIdx}
			, NOW()
		)
	</insert>
	
	<!-- 출고Idx로 배차idx 조회 -->
	<select id="selectByorderIdList" resultType="int">
		SELECT
			dispatch_idx
		FROM
			DISPATCH_ORDER_MAP
		WHERE
			outbound_order_idx = #{outboundOrderIdx}
	</select>
	
	<!-- 배차 상태 취소로 변경 -->
	<update id="updateDispatchStatus">
		UPDATE
			DISPATCH
		SET
			status = #{status}
			, updated_at = NOW()
		WHERE
			dispatch_idx = #{dispatchIdx}
	</update>
	
	<!-- 배차 상태 확인 -->
	<select id="selectDispatchStatus" resultType="string">
		SELECT
			status
		FROM
			DISPATCH
		WHERE
			dispatch_idx = #{dispatchIdx}
	</select>
	
	<!-- 배차 상세 정보(예약 및 취소 상태일 경우)  -->
	<select id="selectDispatchSummary" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_DISPATCH_DETAIL
		WHERE
			dispatch_idx = #{dispatchIdx}
		AND
			vehicle_idx = #{vehicleIdx}
	</select>
	
	<!-- 배차 상제 정보(적재 완료 후) -->
	<!-- 수주 확인서 품목 매핑 -->
	<resultMap id="deliveryConfirmationItemMap" type="DeliveryConfirmationItemDTO">
	    <id property="confirmationItemIdx" column="confirmation_item_idx"/>
	    <result property="confirmationIdx" column="delivery_confirmation_idx"/>
	    <result property="productIdx" column="product_idx"/>
	    <result property="itemName" column="item_name"/>
	    <result property="orderedQty" column="ordered_qty"/>
	    <result property="deliveredQty" column="delivered_qty"/>
	    <result property="status" column="item_status"/>
	    <result property="note" column="item_note"/>
	</resultMap>
	
	<!-- 수주 확인서 매핑 -->
	<resultMap id="deliveryConfirmationMap" type="DeliveryConfirmationDTO">
	    <id property="deliveryConfirmationIdx" column="delivery_confirmation_idx"/>
	    <result property="dispatchAssignmentIdx" column="dispatch_assignment_idx"/>
	    <result property="dispatchStopIdx" column="dispatch_stop_idx"/>
	    <result property="outboundOrderIdx" column="outbound_order_idx"/>
	    <result property="confirmationTime" column="confirmation_time"/>
	    <result property="receiverName" column="receiver_name"/>
	    <result property="note" column="note"/>
	    <association property="fileList" resultMap="FileResultMap" />
	
	    <!-- 자식: 수주확인서 품목 -->
	    <collection property="items" ofType="DeliveryConfirmationItemDTO"
	                resultMap="deliveryConfirmationItemMap"/>
	</resultMap>
	
	<!-- 경유지 매핑 -->
	<resultMap id="dispatchStopMap" type="DispatchStopDTO">
	    <id property="dispatchStopIdx" column="dispatch_stop_idx"/>
	    <result property="dispatchIdx" column="dispatch_idx"/>
	    <result property="dispatchAssignmentIdx" column="dispatch_assignment_idx"/>
	    <result property="deliverySequence" column="delivery_sequence"/>
	    <result property="franchiseIdx" column="franchise_idx"/>
	    <result property="franchiseName" column="franchise_name"/>
	    <result property="regionIdx" column="region_idx"/>
	    <result property="regionName" column="common_code_name"/>
	    <result property="address" column="franchise_address1"/>
	    <result property="dispatchStopStatus" column="status"/>
	    <result property="arrivalTime" column="arrival_time"/>
	    <result property="completeTime" column="complete_time"/>
	    <result property="note" column="note"/>
	
	    <!-- 자식: 수주확인서 리스트 -->
	    <collection property="deliveryConfirmations" ofType="DeliveryConfirmationDTO"
	                resultMap="deliveryConfirmationMap"/>
	</resultMap>
	
	<!-- 최상위 Dispatch 상세 -->
	<resultMap id="dispatchDetailMap" type="DispatchDetailDTO">
	    <id property="dispatchIdx" column="dispatch_idx"/>
	    <result property="dispatchDate" column="dispatch_date"/>
	    <result property="driverName" column="driver_name"/> 
	    <result property="startSlot" column="start_slot"/>
	    <result property="status" column="status"/>
	    <result property="urgent" column="urgent"/>
	    <result property="vehicleIdx" column="vehicle_idx"/>
	    <result property="vehicleNumber" column="vehicle_number"/>
	    <result property="capacity" column="capacity"/>
	    <result property="orderIds" column="order_ids"/>
	    <result property="totalVolume" column="total_volume"/>
	    <result property="totalQty" column="total_qty"/>
	    <result property="franchiseManagerName" column="franchise_manager_name"/>
	    <result property="requiresAdditional" column="requires_additional"/>
	
	    <!-- ✅ 지점 매핑 -->
	    <collection property="franchises" ofType="DispatchStopDTO"
	                resultMap="dispatchStopMap"/>
	</resultMap>
	<select id="selectDispatchDetail" resultMap="dispatchDetailMap">
	    SELECT
	        d.dispatch_idx
	        , d.dispatch_date
	        , d.start_slot
	        , d.urgent
	        , d.requires_additional
	        , e.emp_name AS driver_name
	        , v.vehicle_idx
	        , v.vehicle_number
	        , v.capacity
	        , ds.dispatch_stop_idx
	        , ds.delivery_sequence
	        , ds.franchise_idx
	        , f.franchise_name
	        , f.region_idx
	        , f.franchise_manager_name
	        , f.franchise_address1
	        , c.common_code_name AS region_name
	        , dc.delivery_confirmation_idx
	        , dc.outbound_order_idx AS outbound_order_idx
	        , dc.receiver_name
	        , dc.confirmation_time
	        , dc.note
	        , dci.confirmation_item_idx
	        , dci.product_idx
	        , dci.item_name
	        , dci.ordered_qty
	        , dci.delivered_qty
	        , dci.status AS item_status
	        , da.dispatch_assignment_idx
	        , ds.arrival_time
	        , ds.complete_time
	        , ds.status AS status
			, file.original_file_name
			, file.target_table_idx
			, file.real_file_name
			, file.file_idx
	    FROM 
	    	DISPATCH d
	    JOIN 
	    	DISPATCH_ASSIGNMENT da 
	    ON 
	    	d.dispatch_idx = da.dispatch_idx
	    JOIN 
	    	VEHICLE v              
	    ON 
	    	da.vehicle_idx = v.vehicle_idx
	    JOIN 
	    	DISPATCH_STOP ds       
	    ON 
	    	d.dispatch_idx = ds.dispatch_idx 
	    AND 
	    	da.dispatch_assignment_idx = ds.dispatch_assignment_idx
	    JOIN 
	    	FRANCHISE f            
	    ON 
	    	ds.franchise_idx = f.franchise_idx
	    JOIN 
	    	COMMON_CODE c          
	    ON 
	    	f.region_idx = c.common_code_idx
	    JOIN 
	    	DELIVERY_CONFIRMATION dc 
	    ON 
	    	ds.dispatch_stop_idx = dc.dispatch_stop_idx
	    JOIN 
	    	DISPATCH_STOPDELIVERY_CONFIRMATION_ITEM dci 
	    ON 
	    	dc.delivery_confirmation_idx = dci.confirmation_idx
	    JOIN 
	    	EMPLOYEE_INFO e 
	    ON 
	    	da.driver_idx = e.emp_idx
	    LEFT JOIN
			FILE file
		ON
			dc.delivery_confirmation_idx = file.target_table_idx
	    WHERE 
	    	d.dispatch_idx = #{dispatchIdx}
	    AND 
	    	da.vehicle_idx = #{vehicleIdx}
	    ORDER BY 
	    	ds.delivery_sequence, f.franchise_name, dci.item_name
	</select>
	
	<!-- 배차 정보 조회 (차량idx로 조회) -->
	<select id="selectDispatchByVehicleIdx" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_DISPATCH_DETAIL
		WHERE
			vehicle_idx = #{vehicleIdx}
		ORDER BY
			dispatch_date DESC
	</select>
	
	<!-- 마이페이지 배차 상세 정보 조회 --> 
	<resultMap id="DispatchDetailResultMap" type="DispatchDetailDTO"> 
		<!-- 배차 기본정보 --> 
		<id property="dispatchIdx" column="dispatch_idx"/> 
		<result property="dispatchDate" column="dispatch_date"/> 
		<result property="driverName" column="driver_name"/> 
		<result property="startSlot" column="start_slot"/> 
		<result property="status" column="status"/> 
		<result property="urgent" column="urgent"/> 
		<result property="vehicleIdx" column="vehicle_idx"/> 
		<result property="vehicleNumber" column="vehicle_number"/> 
		<result property="capacity" column="capacity"/> 
		<result property="orderIds" column="order_ids"/> 
		<result property="totalVolume" column="total_volume"/> 
		<result property="totalQty" column="total_qty"/> 
		<collection property="franchises" ofType="DispatchFranchiseDTO"> 
			<id property="franchiseIdx" column="franchise_idx"/> 
			<id property="outboundOrderIdx" column="outbound_order_idx"/>
			<result property="franchiseName" column="franchise_name"/> 
			<result property="regionIdx" column="region_idx"/> 
			<result property="regionName" column="region_name"/> 
			<result property="franchiseZipcode" column="franchise_zipcode"/> 
			<result property="franchiseAddress1" column="franchise_address1"/> 
			<result property="franchiseAddress2" column="franchise_address2"/> 
			<result property="franchisePhone" column="franchise_phone"/> 
			<result property="franchiseManagerName" column="franchise_manager_name"/> 
			<result property="outboundOrderStatus" column="franchise_status"/> 
			<collection property="items" ofType="OutboundOrderItemDTO"> 
				<id property="outboundOrderItemIdx" column="outbound_order_item_idx"/> 
				<result property="outboundOrderIdx" column="outbound_order_idx"/> 
				<result property="productIdx" column="product_idx"/> 
				<result property="productName" column="product_name"/> 
				<result property="receiptProductIdx" column="receipt_product_idx"/> 
				<result property="quantity" column="quantity"/> 
				<result property="productVolume" column="product_volume"/> 
			</collection> 
		</collection> 
	</resultMap> 
	<select id="selectMyDispatchInfo" resultMap="DispatchDetailResultMap"> 
		SELECT 
			d.dispatch_idx 
			, d.dispatch_date 
			, d.start_slot 
			, da.status 
			, d.urgent 
			, c.common_code_name AS region_name 
			, f.franchise_idx 
			, f.franchise_name 
			, f.franchise_manager_name
			, da.driver_idx 
			, e.emp_name AS driver_name 
			, v.vehicle_idx 
			, v.vehicle_number 
			, v.capacity 
			, o.outbound_order_idx  AS outbound_order_idx
			, oi.outbound_order_item_idx 
			, p.product_idx 
			, p.product_name 
			, oi.quantity 
			, p.product_volume 
			, o.status AS outboundOrderStatus
		FROM 
			DISPATCH d 
		JOIN 
			DISPATCH_ASSIGNMENT da 
		ON 
			d.dispatch_idx = da.dispatch_idx 
		JOIN 
			EMPLOYEE_INFO e 
		ON 
			da.driver_idx = e.emp_idx 
		JOIN 
			VEHICLE v 
		ON 
			da.vehicle_idx = v.vehicle_idx 
		JOIN 
			DISPATCH_ORDER_MAP dom 
		ON 
			d.dispatch_idx = dom.dispatch_idx 
		JOIN
			 OUTBOUND_ORDER o 
		ON 
			dom.outbound_order_idx = o.outbound_order_idx 
		JOIN 
			FRANCHISE f 
		ON 
			o.franchise_idx = f.franchise_idx 
		LEFT JOIN 
			COMMON_CODE c 
		ON 
			f.region_idx = c.common_code_idx 
		JOIN 
			OUTBOUND_ORDER_ITEM oi 
		ON 
			o.outbound_order_idx = oi.outbound_order_idx 
		JOIN 
			PRODUCT p 
		ON 
			oi.product_idx = p.product_idx 
		WHERE 
			d.dispatch_idx = #{dispatchIdx}
		AND 
			da.vehicle_idx = #{vehicleIdx}
    	ORDER BY
			f.franchise_name, p.product_name 
	</select>
	
	<!-- 배차 배정 테이블 조회 -->
	<select id="selectAssigmentIdx" resultType="int">
		SELECT 
			dispatch_assignment_idx
		FROM
			DISPATCH_ASSIGNMENT
		WHERE
			dispatch_idx = #{dispatchIdx}
		AND
			vehicle_idx = #{vehicleIdx}
			
	</select>
	
	<!-- 배차에 배정된 차량 목록 조회 -->
	<select id="selectAllVehicleIdx" resultType="int">
		SELECT
			vehicle_idx
		FROM	
			DISPATCH_ASSIGNMENT
		WHERE
			dispatch_idx = #{dispatchIdx}
	</select>
	
	<!-- 경유지 데이터 등록 -->
	<insert id="insertDispatchStop" useGeneratedKeys="true" keyProperty="dispatchStopIdx">
		INSERT INTO DISPATCH_STOP (
			dispatch_idx
			, dispatch_assignment_idx
			, delivery_sequence
			, franchise_idx
			, status
			, urgent
		)
		VALUES (
			#{dispatchIdx}
			, #{dispatchAssignmentIdx}
			, #{deliverySequence}
			, #{franchiseIdx}
			, #{dispatchStopStatus}
			, #{urgent}
		)
	</insert>
	
	<!-- 수주확인서 데이터 등록 -->
	<insert id="insertDeliveryConfirmation" useGeneratedKeys="true" keyProperty="deliveryConfirmationIdx">
		INSERT INTO DELIVERY_CONFIRMATION (
			dispatch_assignment_idx
			, dispatch_stop_idx
			, outbound_order_idx
		)
		VALUES (
			#{dispatchAssignmentIdx}
			, #{dispatchStopIdx}
			, #{outboundOrderIdx}
		)
	</insert>
	
	<!-- 수주확인서품목 데이터 등록 -->
	<insert id="insertDeliveryConfirmationItem">
		INSERT INTO DISPATCH_STOPDELIVERY_CONFIRMATION_ITEM (
			confirmation_idx
			, product_idx
			, item_name
			, ordered_qty
		)
		VALUES (
			#{confirmationIdx}
			, #{productIdx}
			, #{itemName}
			, #{orderedQty}
		)
	</insert>
	
	<!-- 현재 기사 Assignment 상태를 변경 -->
	<update id="updateAssigmentStatus">
		UPDATE
			DISPATCH_ASSIGNMENT
		SET
			status = #{status}
		WHERE
			dispatch_assignment_idx = #{assigmentIdx}
	</update>
	
	<!-- 배차idx로 Assignment 상태 변경 -->
	<update id="updateAssigmentStatusByDispatchIdx">
		UPDATE
			DISPATCH_ASSIGNMENT
		SET
			status = #{status}
		WHERE
			dispatch_idx = #{dispatchIdx}
	</update>
	
	<!-- 같은 배차에 배정된 기사 수 카운트 -->
	<select id="selectCountAssigment" resultType="int">
		SELECT
			COUNT(dispatch_assignment_idx)
		FROM
			DISPATCH_ASSIGNMENT
		WHERE
			dispatch_idx = #{dispatchIdx}
	</select>
	
	<!-- 상태에 따라 완료한 기사 수 카운트 -->
	<select id="selectCountAssignmentsByStatus" resultType="int">
		SELECT
			COUNT(dispatch_assignment_idx)
		FROM
			DISPATCH_ASSIGNMENT
		WHERE
			dispatch_idx = #{dispatchIdx}
		AND
			status = #{status}
	</select>
	
	<!-- 배정된 경유지 중 제일 첫 배송지 -->
	<select id="selectFirstStopIdx" resultType="int">
		SELECT 
			ds.dispatch_stop_idx
    	FROM 
    		DISPATCH_STOP ds
    	WHERE 
    		ds.dispatch_idx = #{dispatchIdx}
      	AND 
      		ds.dispatch_assignment_idx = (
          		SELECT 
          			da.dispatch_assignment_idx
          		FROM 
          			DISPATCH_ASSIGNMENT da
          		WHERE 
          			da.dispatch_idx = #{dispatchIdx}
            	AND 
            		da.vehicle_idx = #{vehicleIdx}
      )
    	ORDER BY 
    		ds.delivery_sequence ASC
    	LIMIT 1
	</select>
	
	<!-- 경유지 테이블 상태 변경 -->
	<update id="updateDispatchStopStatus">
		UPDATE
			DISPATCH_STOP
		SET
			status = #{status}
		WHERE
			dispatch_stop_idx = #{firstStopIdx}
	</update>
	
	<!-- 경유지 테이블 업데이트(상태 및 시간) -->
	<update id="updateDispatchStopCompleted">
		UPDATE
			DISPATCH_STOP
		SET
			status = #{status}
			, arrival_time = NOW()
			, complete_time = NOW()
		WHERE
			dispatch_stop_idx = #{dispatchStopIdx}
	</update>
	
	<!-- 수주확인서 업데이트 -->
	<update id="updateDeliveryConfirmation">
		UPDATE
			DELIVERY_CONFIRMATION
		SET
			confirmation_time = NOW()
			, receiver_name = #{receiverName}
		WHERE
			delivery_confirmation_idx = #{deliveryConfirmationIdx}
	</update>
	
	<!-- 수주확인서 품목 업데이트 -->
	<update id="updateDeliveryConfirmationItem">
		UPDATE
			DISPATCH_STOPDELIVERY_CONFIRMATION_ITEM
		SET
			delivered_qty = #{deliveredQty}
			, status = #{status}
		WHERE
			confirmation_item_idx = #{confirmationItemIdx}
	</update>
	
	<!-- 배정된 기사의 상태 -->
	<select id="selectDispatchAssignment" resultType="string">
		SELECT 
			status
		FROM
			DISPATCH_ASSIGNMENT
		WHERE
			dispatch_idx = #{dispatchIdx}
        AND 
            vehicle_idx = #{vehicleIdx}
	</select>
	
	<!-- 배차 매핑 테이블 삭제 -->
	<delete id="deleteMapping">
		DELETE FROM DISPATCH_ORDER_MAP
		WHERE
			dispatch_idx = #{dispatchIdx}
	</delete>
	
	<!-- 출고 idx 조회 -->
	<select id="selectOutboundOrderIdx" resultType="int">
		SELECT
			outbound_order_idx
		FROM
			DISPATCH_ORDER_MAP
		WHERE
			dispatch_idx = #{dispatchIdx}
	</select>
	
	<!-- 상품 번호 조회 -->
	<select id="selectReceiptProductIdxForDisposal" resultType="int">
		SELECT 
			ooi.receipt_product_idx
	    FROM 
	    	OUTBOUND_ORDER_ITEM ooi
	    JOIN 
	    	DELIVERY_CONFIRMATION dc
	    ON 
	    	ooi.outbound_order_idx = dc.outbound_order_idx
	    JOIN 
	    	DISPATCH_STOPDELIVERY_CONFIRMATION_ITEM dci
	    ON 
	    	dc.delivery_confirmation_idx = dci.confirmation_idx
	    AND 
	    	ooi.product_idx = dci.product_idx
	    WHERE 
	    	dc.delivery_confirmation_idx = #{deliveryConfirmationIdx}
	    AND 
	    	dci.confirmation_item_idx = #{confirmationItemIdx}
	</select>
	
	<!-- 기사의 배송 상태 횟수 -->
	<select id="selectAssignmentStatusCount" resultType="map">
		SELECT
			COALESCE(SUM(CASE WHEN status = '운행중' THEN 1 ELSE 0 END), 0) AS dispatchInProgressCount,
        	COALESCE(SUM(CASE WHEN status = '완료' THEN 1 ELSE 0 END), 0) AS dispatchCompletedCount
		FROM 
			DISPATCH_ASSIGNMENT
		WHERE
			DATE(updated_at) = CURRENT_DATE
	</select>
	
	<!-- 긴급 요청 -->
	<select id="selectUrgentDispatchCount" resultType="int">
		SELECT
			COUNT(*)
		FROM
			OUTBOUND_ORDER
		WHERE 
			urgent = 'Y' 
		AND
			 status = '배차대기'
		AND 
			DATE(updated_at) = CURRENT_DATE
	</select>
	
	<!-- 수주확인서 목록 -->
	<select id="selectAllDeliveryConfirmation" resultType="map">
		SELECT
			dc.updated_at, e.emp_name, fa.franchise_name, dc.receiver_name, dc.delivery_confirmation_idx
		FROM
			DELIVERY_CONFIRMATION dc
		JOIN
			DISPATCH_ASSIGNMENT da
		ON 
			dc.dispatch_assignment_idx = da.dispatch_assignment_idx
		JOIN
			EMPLOYEE_INFO e
		ON
			da.driver_idx = e.emp_idx
		JOIN
			DISPATCH_STOP ds
		ON
			dc.dispatch_stop_idx = ds.dispatch_stop_idx
		JOIN
			FRANCHISE fa
		ON
			fa.franchise_idx = ds.franchise_idx
		ORDER BY
			dc.updated_at DESC
		LIMIT 3
	</select>
	
	<!-- 기사 이름 조회 -->
	<select id="selectDriverName" resultType="string">
		SELECT
			e.emp_name
		FROM 
			DELIVERY_CONFIRMATION dc
		JOIN 
			DISPATCH_ASSIGNMENT da
		ON 
			dc.dispatch_assignment_idx = da.dispatch_assignment_idx
		JOIN 
			EMPLOYEE_INFO e
		ON 
			da.driver_idx = e.emp_idx
		WHERE 
			dc.delivery_confirmation_idx = #{deliveryConfirmationIdx}
	</select>
	
	<!-- 반품 폐기 처리 -->
	<insert id="insertDeliveryDisposal">
		INSERT INTO DISPOSAL (
			emp_idx
			, section
			, receipt_product_idx
			, disposal_amount
			, note
		)
		VALUES (
			#{empIdx}
			, #{section}
			, #{receiptProductIdx}
			, #{disposalAmount}
			, #{note}
		)
	</insert>
	
	<!-- 출고 주문 테이블 상태 변경 -->
	<update id="updateOutboundOrderStatus" >
		UPDATE 	
			OUTBOUND_ORDER
		SET
			status = #{status}
			, updated_at = NOW()
		WHERE
			outbound_order_idx = #{outboundOrderIdx}
	</update>
	
	<!-- 출고 대기 시간 변경 -->
	<update id="updateOutboundWaiting">
		UPDATE
			OUTBOUND_WAITING
		SET
			departure_date = NOW()
		WHERE
			outbound_order_idx = #{outboundOrderIdx}
	</update>
	
	<!-- 출고 테이블 상태 확인 -->
	<select id="selectOutboundOrderStatus" resultType="string">
		SELECT
			status
		FROM
			OUTBOUND_ORDER
		WHERE
			outbound_order_idx = #{outboundOrderIdx}
	</select>
	
	<!-- 배차대기(출고 요청) 요청 횟수  -->
	<select id="selectPendingDispatchCount" resultType="int">
		SELECT
			COUNT(*)
		FROM
			OUTBOUND_ORDER
		WHERE
			status = '배차대기'
	</select>
	<!-- 배차정보 불러오기 (배차idx + 사원idx) -->
	<select id="selectDispatchDetailByDispatchIdx" resultType="DispatchRegisterRequestDTO">
		SELECT *
		FROM V_DISPATCH_DETAIL
		WHERE dispatch_idx = #{dispatchIdx}
		AND emp_idx = #{empIdx}
	</select>

	<!-- 수주 확인서 매핑 리절트맵 -->
	<resultMap id="deliveryConfirmationAddFranchiseNameMap" type="DeliveryConfirmationDTO">
	    <id property="deliveryConfirmationIdx" column="delivery_confirmation_idx"/>
	    <result property="dispatchAssignmentIdx" column="dispatch_assignment_idx"/>
	    <result property="dispatchStopIdx" column="dispatch_stop_idx"/>
	    <result property="outboundOrderIdx" column="outbound_order_idx"/>
	    <result property="confirmationTime" column="confirmation_time"/>
	    <result property="receiverName" column="receiver_name"/>
	    <result property="note" column="note"/>
	    <result property="franchiseName" column="franchise_name"/>
	    <association property="fileList" resultMap="FileResultMap" />
	    <!-- 자식: 수주확인서 품목 -->
	    <collection property="items" ofType="DeliveryConfirmationItemDTO"
	                resultMap="deliveryConfirmationItemMap"/>
	</resultMap>
	<!-- 수주확인서 상세 -->
	<select id="selectDeliveryConfirmationByDeliveryConfirmationIdx" resultMap="deliveryConfirmationAddFranchiseNameMap">
		SELECT
			dc.delivery_confirmation_idx
			, dc.outbound_order_idx
			, dc.receiver_name
			, dsci.item_name
			, dsci.ordered_qty
			, dsci.delivered_qty
			, dsci.status as item_status
			, f.franchise_name
			, file.original_file_name
			, file.target_table_idx
			, file.real_file_name
			, file.file_idx
		FROM 
			DELIVERY_CONFIRMATION dc
		LEFT JOIN 
			DISPATCH_STOP ds
		ON 
			ds.dispatch_stop_idx = dc.dispatch_stop_idx
		LEFT JOIN 
			FRANCHISE f
		ON 
			f.franchise_idx = ds.franchise_idx
		LEFT JOIN 
			DISPATCH_STOPDELIVERY_CONFIRMATION_ITEM dsci
		ON 
			dsci.confirmation_idx = dc.delivery_confirmation_idx
		LEFT JOIN
			FILE file
		ON
			dc.delivery_confirmation_idx = file.target_table_idx
		WHERE 
			delivery_confirmation_idx = #{deliveryConfirmationIdx}
	</select>
</mapper>
