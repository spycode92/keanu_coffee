<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.keanu_coffee.inventory.mapper.InventorySearchMapper">
	
	<!-- Ï¥ù SKU: ÏÑúÎ°ú Îã§Î•∏ ÏÉÅÌíà ÏΩîÎìú(product_idx) Í∞úÏàò -->
    <select id="selectTotalSku" resultType="int">
        SELECT COUNT(DISTINCT product_idx)
        FROM INVENTORY
    </select>

    <!-- Ï¥ù Ïû¨Í≥† ÏàòÎüâ: Ï†ÑÏ≤¥ quantity Ìï©Í≥Ñ -->
    <select id="selectTotalQuantity" resultType="int">
        SELECT COALESCE(SUM(quantity), 0)
        FROM INVENTORY
    </select>
	
	<!-- Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù Ï°∞Ìöå -->
	<select id="selectCategoryList" parameterType="string" resultType="CommonCodeDTO">
	    SELECT
	        common_code_idx  AS commonCodeIdx,
	        common_code      AS commonCode,
	        common_code_name AS commonCodeName,
	        group_code       AS groupCode
	    FROM COMMON_CODE
	    WHERE group_code = #{groupCode}
	    ORDER BY common_code_name
	</select>
	
	<!-- Ï¥ù Îç∞Ïù¥ÌÑ∞ Í∞úÏàò -->
	<select id="selectInventoryCount" resultType="int">
	    SELECT COUNT(1)
	    FROM INVENTORY i
	    JOIN PRODUCT p 
	        ON i.product_idx = p.product_idx
	    JOIN RECEIPT_PRODUCT r 
	        ON i.receipt_product_idx = r.receipt_product_idx
	    LEFT JOIN SUPPLIER s 
	        ON r.supplier_idx = s.supplier_idx
	    LEFT JOIN WAREHOUSE_LOCATION w
	        ON i.location_idx = w.location_idx
	    LEFT JOIN COMMON_CODE c
	        ON p.category_idx = c.common_code_idx
	       AND c.group_code = 'CATEGORY'
	    <where>
	        <!-- Í≤ÄÏÉâ ÌÇ§ÏõåÎìú -->
	        <if test="keyword != null and keyword != ''">
	            (p.product_name LIKE CONCAT('%', #{keyword}, '%')
	             OR CAST(p.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	             OR r.lot_number LIKE CONCAT('%', #{keyword}, '%'))
	        </if>
	
	        <!-- Î°úÏºÄÏù¥ÏÖòÎ™Ö -->
	        <if test="location != null and location != ''">
	            AND i.location_name = #{location}
	        </if>
	
	        <!-- Î°úÏºÄÏù¥ÏÖò Ïú†Ìòï -->
	        <if test="locationType != null and locationType != '' and locationType != 'Ï†ÑÏ≤¥'">
	            AND w.location_type = #{locationType} 
	        </if>
			
			<!-- üìå Ï∂îÍ∞Ä: ÎßåÎ£å Ï†úÏô∏ Ï°∞Í±¥ -->
        	AND r.expiration_date &gt;= CURDATE()
			
	        <!-- ÎÇ†Ïßú Ï°∞Í±¥ -->
			<if test="mfgDate != null and mfgDate != '' and (expDate == null or expDate == '')">
			    <!-- Ï†úÏ°∞ÏùºÏûêÎßå ÏûÖÎ†• Ïãú: Ìï¥Îãπ ÏùºÏûê Ïù¥ÏÉÅ -->
			    AND r.manufacture_date &gt;= #{mfgDate}
			</if>
			
			<if test="expDate != null and expDate != '' and (mfgDate == null or mfgDate == '')">
			    <!-- Ïú†ÌÜµÍ∏∞ÌïúÎßå ÏûÖÎ†• Ïãú: Ìï¥Îãπ ÏùºÏûê Ïù¥Ìïò -->
			    AND r.expiration_date &lt;= #{expDate}
			</if>
			
			<if test="mfgDate != null and mfgDate != '' and expDate != null and expDate != ''">
			    <!-- Îëò Îã§ ÏûÖÎ†• Ïãú: Íµ¨Í∞Ñ Í≤ÄÏÉâ -->
			    AND r.manufacture_date &gt;= #{mfgDate}
			    AND r.expiration_date &lt;= #{expDate}
			</if>
	
	        <!-- Ïû¨Í≥† ÏÉÅÌÉú -->
	        <if test="stockStatus != null and stockStatus != '' and stockStatus != 'Ï†ÑÏ≤¥'">
	            <choose>
	                <when test="stockStatus == 'EXPIRED'">
	                    AND r.expiration_date &lt; CURDATE()
	                </when>
	                <when test="stockStatus == 'WARN'">
	                    AND DATEDIFF(r.expiration_date, CURDATE()) BETWEEN 0 AND 60
	                </when>
	                <when test="stockStatus == 'OK'">
	                    AND r.expiration_date &gt; DATE_ADD(NOW(), INTERVAL 60 DAY)
	                    AND i.quantity &gt; 0
	                </when>
	            </choose>
	        </if>
	
	        <!-- ‚úÖ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ -->
	        <if test="category != null and category != '' and category != 'Ï†ÑÏ≤¥'">
			    AND c.common_code_idx = #{category}
			</if>
	    </where>
	</select>
	
	<!-- Ïû¨Í≥† Î¶¨Ïä§Ìä∏ Ï°∞Ìöå -->
	<select id="selectReceiptProductList" resultType="map">
	    SELECT
	        i.inventory_idx,
	        i.receipt_product_idx,
	        r.lot_number,
	        r.manufacture_date,
	        r.expiration_date,
	        r.received_at,
	        i.quantity AS current_quantity,   
	        p.product_idx,
	        p.product_name,
	        p.category_idx,
	        c.common_code      AS categoryCode,
	        c.common_code_name AS categoryName,
	        i.location_name,                  
	        i.location_idx,
	        w.location_type,
	        s.supplier_name,
	        CASE
	            WHEN r.expiration_date &lt; CURDATE() THEN 'EXPIRED'
	            WHEN DATEDIFF(r.expiration_date, CURDATE()) BETWEEN 0 AND 60 THEN 'WARN'
	            ELSE 'OK'
	        END AS stockStatus
	    FROM INVENTORY i
	    JOIN RECEIPT_PRODUCT r 
	        ON i.receipt_product_idx = r.receipt_product_idx
	    JOIN PRODUCT p 
	        ON i.product_idx = p.product_idx
	    LEFT JOIN SUPPLIER s 
	        ON r.supplier_idx = s.supplier_idx
	    LEFT JOIN WAREHOUSE_LOCATION w 
	        ON i.location_idx = w.location_idx
	    LEFT JOIN COMMON_CODE c
	        ON p.category_idx = c.common_code_idx
	       AND c.group_code = 'CATEGORY'
	    <where>
	        <if test="keyword != null and keyword != ''">
	            (p.product_name LIKE CONCAT('%', #{keyword}, '%')
	             OR CAST(p.product_idx AS CHAR) LIKE CONCAT('%', #{keyword}, '%')
	             OR r.lot_number LIKE CONCAT('%', #{keyword}, '%'))
	        </if>
	        <if test="location != null and location != ''">
	            AND i.location_name = #{location}
	        </if>
	        <if test="locationType != null and locationType != '' and locationType != 'Ï†ÑÏ≤¥'">
	            AND w.location_type = #{locationType}
	        </if>
	        
	        <!-- üìå Ï∂îÍ∞Ä: ÎßåÎ£å Ï†úÏô∏ Ï°∞Í±¥ -->
        	AND r.expiration_date &gt;= CURDATE()
	        
	        <!-- ÎÇ†Ïßú Ï°∞Í±¥ -->
			<if test="mfgDate != null and mfgDate != '' and (expDate == null or expDate == '')">
			    <!-- Ï†úÏ°∞ÏùºÏûêÎßå ÏûÖÎ†• Ïãú: Ìï¥Îãπ ÏùºÏûê Ïù¥ÏÉÅ -->
			    AND r.manufacture_date &gt;= #{mfgDate}
			</if>
			
			<if test="expDate != null and expDate != '' and (mfgDate == null or mfgDate == '')">
			    <!-- Ïú†ÌÜµÍ∏∞ÌïúÎßå ÏûÖÎ†• Ïãú: Ìï¥Îãπ ÏùºÏûê Ïù¥Ìïò -->
			    AND r.expiration_date &lt;= #{expDate}
			</if>
			
			<if test="mfgDate != null and mfgDate != '' and expDate != null and expDate != ''">
			    <!-- Îëò Îã§ ÏûÖÎ†• Ïãú: Íµ¨Í∞Ñ Í≤ÄÏÉâ -->
			    AND r.manufacture_date &gt;= #{mfgDate}
			    AND r.expiration_date &lt;= #{expDate}
			</if>
	
	        <!-- Ïû¨Í≥† ÏÉÅÌÉú ÌïÑÌÑ∞ -->
	        <if test="stockStatus != null and stockStatus != '' and stockStatus != 'Ï†ÑÏ≤¥'">
	            <choose>
	                <when test="stockStatus == 'EXPIRED'">
	                    AND r.expiration_date &lt; CURDATE()
	                </when>
	                <when test="stockStatus == 'WARN'">
	                    AND DATEDIFF(r.expiration_date, CURDATE()) BETWEEN 0 AND 60
	                </when>
	                <when test="stockStatus == 'OK'">
	                    AND r.expiration_date &gt; DATE_ADD(NOW(), INTERVAL 60 DAY)
	                    AND i.quantity &gt; 0
	                </when>
	            </choose>
	        </if>
	
	        <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ -->
	        <if test="category != null and category != '' and category != 'Ï†ÑÏ≤¥'">
			    AND c.common_code_idx = #{category}
			</if>
	    </where>
	
	    <!-- Ï†ïÎ†¨ Ï°∞Í±¥ -->
	    <choose>
	        <when test="sortOption == 'manufactureAsc'">
	            ORDER BY r.manufacture_date ASC
	        </when>
	        <when test="sortOption == 'manufactureDesc'">
	            ORDER BY r.manufacture_date DESC
	        </when>
	        <when test="sortOption == 'expireAsc'">
	            ORDER BY r.expiration_date ASC
	        </when>
	        <when test="sortOption == 'expireDesc'">
	            ORDER BY r.expiration_date DESC
	        </when>
	        <when test="qtySort == 'qtyDesc'">
	            ORDER BY COALESCE(i.quantity, 0) DESC
	        </when>
	        <when test="qtySort == 'qtyAsc'">
	            ORDER BY COALESCE(i.quantity, 0) ASC
	        </when>
	        <otherwise>
	            ORDER BY r.received_at DESC
	        </otherwise>
	    </choose>
	
	    LIMIT #{startRow}, #{listLimit}
	</select>
	
	<!-- ========= Ïû¨Í≥† ÏÉÅÏÑ∏ Î™®Îã¨Ï∞Ω (Ajax) ========= -->
	<!-- Ïû¨Í≥† ÏÉÅÏÑ∏ -->
	<select id="selectInventoryDetail" parameterType="int" resultType="map">
	    SELECT r.receipt_product_idx,
	           r.lot_number,
	           DATE_FORMAT(r.manufacture_date, '%Y-%m-%d') AS manufacture_date,
	           DATE_FORMAT(r.expiration_date, '%Y-%m-%d') AS expiration_date,
	           p.product_idx,
	           p.product_name,
	           c.common_code_name AS category_name,                   -- Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ Ï∂îÍ∞Ä
	           s.supplier_name,
	           COALESCE(SUM(i.quantity), 0) AS current_quantity
	    FROM RECEIPT_PRODUCT r
	    JOIN PRODUCT p ON r.product_idx = p.product_idx
	    LEFT JOIN SUPPLIER s ON r.supplier_idx = s.supplier_idx
	    LEFT JOIN INVENTORY i ON r.receipt_product_idx = i.receipt_product_idx
	    LEFT JOIN COMMON_CODE c ON p.category_idx = c.common_code_idx  -- Ï°∞Ïù∏
	    WHERE r.receipt_product_idx = #{receiptProductIdx}
	    GROUP BY r.receipt_product_idx
	</select>
	
	<!-- Î°úÏºÄÏù¥ÏÖò Î∂ÑÌè¨ -->
	<select id="selectLocationDistribution" parameterType="int" resultType="map">
	    SELECT w.location_name,
	           w.location_type,
	           i.quantity AS qty
	    FROM INVENTORY i
	    JOIN WAREHOUSE_LOCATION w ON i.location_idx = w.location_idx
	    WHERE i.receipt_product_idx = #{receiptProductIdx}
	</select>
	
</mapper>










