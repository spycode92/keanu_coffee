<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.keanu_coffee.inventory.mapper.InventoryMoveMapper">
	
	<!-- 상품의존재 유무 체크 -->
	<select id="selectProductByLotNumber" resultType="int">
		SELECT COUNT(*)
		FROM PRODUCT p
		LEFT JOIN INVENTORY i
		ON i.product_idx = p.product_idx
		WHERE i.lot_number = #{lotNumber}
	</select>
	
	
	<!-- 상품의 사진 선택 -->
	<select id="selectProductFileByLotNum" resultType="fileDTO">
		SELECT f.file_idx
		FROM RECEIPT_PRODUCT rp
		LEFT JOIN FILE f
		ON f.target_table = 'PRODUCT'
		AND f.target_table_idx = rp.product_idx
		WHERE rp.lot_number = #{lotNumber}
	</select>
	
	<!-- 로케이션 존재유무 체크 -->
	<select id="selectCountLocationByLocationName" resultType="int"> 
		SELECT COUNT(*)
		FROM WAREHOUSE_LOCATION
		WHERE location_name = #{locationName}
	</select>
	
	<!-- 로케이션에 있는 재고 목록 조회 -->
	<select id="selectInventoryListByLocationName" resultType="com.itwillbs.keanu_coffee.inventory.dto.InventoryDTO">
		SELECT *
		FROM INVENTORY
		WHERE
		location_name = #{locationName}
	</select>
	
	<!-- 로케이션이름과 lot번호로 재고정보조회 -->
	<select id="selectInventoryByLocationNAmeAndLotNumber" resultType="com.itwillbs.keanu_coffee.inventory.dto.InventoryDTO">
		SELECT *
		FROM INVENTORY
		WHERE
			location_name = #{locationName}
		AND
			lot_number = #{lotNumber}
	</select>
	
	<!-- 로케이션정보 조회 -->
	<select id="selectLocationByLocationName" resultType="com.itwillbs.keanu_coffee.inventory.dto.WarehouseLocationDTO">	
		SELECT 
			location_idx
			, location_name
		FROM WAREHOUSE_LOCATION
		WHERE location_name = #{locationName}
	</select>
	
	<!-- 재고입력 -->
	<insert id="insertInventory" useGeneratedKeys="true" keyProperty="inventoryIdx">
		INSERT INTO INVENTORY
		(receipt_product_idx
		, location_idx
		, location_name
		, product_idx
		, quantity
		, lot_number
		, manufacture_date
		, expiration_date)
		VALUES
		(#{receiptProductIdx}
		, #{locationIdx}
		, #{locationName}
		, #{productIdx}
		, #{quantity}
		, #{lotNumber}
		, #{manufactureDate}
		, #{expirationDate})
	</insert>
	
	<!-- 재고수량업데이트 -->
	<update id="updateInventoryQuantity">
		UPDATE INVENTORY
		SET quantity = #{quantity}
		WHERE inventory_idx = #{inventoryIdx}
	</update>
	
	<!-- 로케이션에 동일receiptProduct가 들어있나 확인 -->
	<select id="selectCountSameReceiptIdxAtLocation" resultType="int">
		SELECT COUNT(*)
		FROM INVENTORY
		WHERE receipt_product_idx = #{receiptProductIdx}
		AND location_name = #{locationName} 
	</select>
	
	<!-- 직원 카트의 물건갯수 수정 -->
	<update id="updateInventory" useGeneratedKeys="true" keyProperty="inventoryIdx">
		UPDATE INVENTORY
		SET 
			quantity = quantity + #{quantity}
		WHERE
			location_name = #{locationName}
		AND
			lot_number = #{lotNumber}
	</update>
	
	<!-- 재고물건이동 물건0개시 데이터삭제 -->
	<delete id="deleteInventoryDataByInventoryIdx">
		DELETE FROM INVENTORY
		WHERE inventory_idx = #{inventoryIdx}
	</delete>

	<!-- 카트에담긴 재고상품 조회 -->
	<select id="selectDetailInventoryListByLocationName"  resultType="Map">
		SELECT
			i.lot_number as lotNumber
			, i.quantity as quantity
			, p.product_name as productName
		FROM INVENTORY i
		LEFT JOIN PRODUCT p
		ON i.product_idx = p.product_idx
		WHERE i.location_name = #{locationName}
	</select>
	
	<!-- 전체 로케이션 정보 조회 -->
	<select id="selectAllLocationInfo" resultType="com.itwillbs.keanu_coffee.inventory.dto.WarehouseLocationDTO">
		SELECT location_name
		FROM WAREHOUSE_LOCATION
		WHERE location_type != -1  
	</select>
	
	<!-- lotNumber로 상품이름 조회 -->
	<select id="selectProductName" resultType="STring">
		SELECT product_name
		FROM RECEIPT_PRODUCT rp
		LEFT JOIN PRODUCT p
		ON p.product_idx = rp.product_idx
		WHERE rp.lot_number = #{lotNumber}
	</select>
	
	<!-- receiptProductIdx로 상품 이름 조회 -->
	<select id="selectProductNameWithReceiptProductIdx" resultType="String">
		SELECT product_name
		FROM RECEIPT_PRODUCT rp
		LEFT JOIN PRODUCT p
		ON p.product_idx = rp.product_idx
		WHERE rp.receipt_product_idx = #{receiptProductIdx}
	</select>




</mapper>