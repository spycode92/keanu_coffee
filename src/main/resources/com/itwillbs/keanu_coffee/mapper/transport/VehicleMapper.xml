<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.keanu_coffee.transport.mapper.VehicleMapper">
	<!-- 차량관리 페이징 -->
	<select id="selectVehicleCount" resultType="int">
		SELECT
			COUNT(vehicle_idx)
		FROM 
			VEHICLE
		WHERE
		<choose>
			<when test="filter != null and filter == '미배정'">
				status = '미배정'
			</when>
			<when test="filter != null and filter == '대기'">
				status = '대기'
			</when>
			<when test="filter != null and filter == '운행중'">
				status = '운행중'
			</when>
			<when test="filter != null and filter == '사용불가'">
				status = '사용불가'
			</when>
			<otherwise>
			 	1 = 1
			</otherwise>
		</choose>
		<if test="searchKeyword != null and searchKeyword != ''">
		AND vehicle_number LIKE CONCAT('%', #{searchKeyword}, '%')			
		</if>
	</select>
	
	<!-- 차량 리스트 -->
	<select id="selectVehicleList" resultType="com.itwillbs.keanu_coffee.transport.dto.VehicleDTO">
		SELECT
			v.vehicle_idx AS vehicleIdx
			, v.vehicle_number
			, v.vehicle_type
			, v.capacity
			, v.status
			, v.manufacture_year
			, v.manufacturer_model
			, e.emp_name AS driverName
		FROM
			VEHICLE v
		LEFT OUTER JOIN
			EMPLOYEE_INFO e
		ON 
			v.emp_idx = e.emp_idx
		WHERE 
		<choose>
			<when test="filter != null and filter == '미배정'">
				v.status = '미배정'
			</when>
			<when test="filter != null and filter == '대기'">
				v.status = '대기'
			</when>
			<when test="filter != null and filter == '운행중'">
				v.status = '운행중'
			</when>
			<when test="filter != null and filter == '사용불가'">
				v.status = '사용불가'
			</when>
			<otherwise>
				1 = 1
			</otherwise>
		</choose>
		<if test="searchKeyword != null and searchKeyword != ''">
		AND vehicle_number LIKE CONCAT('%', #{searchKeyword}, '%')			
		</if>
		LIMIT
			#{startRow}     
			, #{listLimit} 
	</select>
	
	<!-- 차량 추가 -->
	<insert id="insertVehicle">
		INSERT INTO VEHICLE
		VALUES(
			null
			, #{vehicleNumber}
			, #{vehicleType}
			, #{capacity}
			, '미배정'
			, #{manufactureYear}
			, #{manufacturerModel}
			, null
			, current_timestamp
			, null
		)
	</insert>
	
	<!-- 차량 상세정보 -->
	<select id="selectByIdx" resultType="com.itwillbs.keanu_coffee.transport.dto.VehicleDTO">
		SELECT
			v.vehicle_idx AS vehicleIdx
			, v.vehicle_number
			, v.vehicle_type
			, v.capacity
			, v.status
			, v.manufacture_year
			, v.manufacturer_model
			, e.emp_name AS driverName
		FROM
			VEHICLE v
		LEFT OUTER JOIN
			EMPLOYEE_INFO e
		ON 
			v.emp_idx = e.emp_idx
		WHERE 
			v.vehicle_idx = #{idx}
	</select>
	
	<!--  차량 상태 사용불가로 상태 변경 -->
	<update id="updateStatus">
		UPDATE 
			VEHICLE
		SET
			status = #{status}
		WHERE
			vehicle_idx 
		IN
		<foreach collection="idx" item="id" open="(" separator="," close=")">
			#{id}
		</foreach>
	</update>
	
	<!-- 배정 가능한 차량 목록 -->
	<select id="selectAvailableList" resultType="com.itwillbs.keanu_coffee.transport.dto.VehicleDTO">
		SELECT
			vehicle_idx
			, vehicle_number
			, vehicle_type
			, capacity
		FROM
			VEHICLE
		WHERE
			status = #{status}
		AND
			emp_idx is null
	</select>
	
	<!-- 기사 배정 -->
	<update id="updateDriver">
		UPDATE
			VEHICLE
		SET
			<choose>
				<when test="isAssign == 'false'">
					emp_idx = #{empIdx}
					, status = '대기'
				</when>
				<otherwise>
					emp_idx = null
					, status = '미배정'
				</otherwise>
			</choose>
		where
			vehicle_idx = #{vehicleIdx}
	</update>
	
	<!-- 차량 정보 수정 -->
	<update id="updateVehicle">
		UPDATE
			VEHICLE
		SET
			vehicle_number = #{vehicleNumber}
			, vehicle_type = #{vehicleType}
			, capacity = #{capacity}
			, manufacture_year = #{manufactureYear}
			, manufacturer_model = #{manufacturerModel}
		WHERE
			vehicle_idx = #{vehicleIdx}
	</update>
	
	<!-- 차량번호 중복검사 (등록 시) -->
	<select id="countByVehicleNumber" resultType="int">
		SELECT 
			COUNT(*)
		FROM
			VEHICLE
		WHERE
			vehicle_number = #{vehicleNumber}
	</select>
	
	<!-- 차량번호 중복검사 (수정 시) -->
	<select id="countByVehicleNumberExceptSelf" resultType="int">
		SELECT 
			COUNT(*)
		FROM 
			VEHICLE
		WHERE
			vehicle_number = #{vehicleNumber}
		AND 
			vehicle_idx != #{vehicleIdx}
	</select>
</mapper>


