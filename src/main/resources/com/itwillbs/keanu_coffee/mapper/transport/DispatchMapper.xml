<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itwillbs.keanu_coffee.transport.mapper.DispatchMapper">
	<!-- 배차 카운트 -->
	<select id="selectDispatchCount" resultType="int">
		SELECT
			COUNT(dispatch_idx)
		FROM
			V_DISPATCH_DETAIL
		WHERE
			1 = 1
			<if test="filter != null and filter != '전체'">
			AND
				status = #{filter}
			</if>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND 
					(region_name LIKE CONCAT ('%', #{searchKeyword}, '%')
				OR
					driver_name LIKE CONCAT ('%', #{searchKeyword}, '%')
				OR 
					vehicle_number LIKE CONCAT ('%', #{searchKeyword}, '%'))
			</if>
	</select>
	
	<!-- 배차 리스트 -->
	<select id="selectAllDispatch" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_DISPATCH_DETAIL
		WHERE
			1 = 1
			<if test="filter != null and filter != '전체'">
			AND
				status = #{filter}
			</if>
			<if test="searchKeyword != null and searchKeyword != ''">
				AND 
					(region_name LIKE CONCAT ('%', #{searchKeyword}, '%')
				OR
					driver_name LIKE CONCAT ('%', #{searchKeyword}, '%')
				OR 
					vehicle_number LIKE CONCAT ('%', #{searchKeyword}, '%'))
			</if>
		ORDER BY 
			dispatch_date DESC
			, start_slot ASC
		LIMIT
			#{startRow}     
			, #{listLimit} 
	</select>

	<!-- 배차 요청 리스트 -->
	<select id="selectDispatchList" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_OUTBOUND_REGION_GROUP
	</select>
	
	<!-- 배차 등록 -->
	<insert id="insertDispatch" useGeneratedKeys="true" keyProperty="dispatchIdx">
		INSERT INTO DISPATCH (
			dispatch_date
	        , start_slot
	        , region_idx
	        , created_at
	        , status
	        , urgent
	        , requires_additional
		)
		VALUES (
			#{dispatchDate}
			, #{startSlot}
			, #{regionIdx}
			, NOW()
			, #{status}
			, #{urgent}
			, #{requiresAdditional}
		)
	</insert>
	
	<!-- 배차 배정 테이블 등록 -->
	<insert id="insertDispatchAssignment">
		INSERT INTO DISPATCH_ASSIGNMENT (
			dispatch_idx
			, driver_idx
			, vehicle_idx
			, status
			, created_at
		)
		VALUES (
			#{dispatchIdx}
			, #{empIdx}
			, #{vehicleIdx}
			, #{status}
			, NOW()
		)
	</insert>
	
	<!-- 배차 매핑 테이블 등록 -->
	<insert id="insertDispatchOrderMap">
		INSERT INTO DISPATCH_ORDER_MAP (
			dispatch_idx
			, outbound_order_idx
			, created_at
		)
		VALUES (
			#{dispatchIdx}
			, #{outboundOrderIdx}
			, NOW()
		)
	</insert>
	
	<!-- 출고Idx로 배차idx 조회 -->
	<select id="selectByorderIdList" resultType="int">
		SELECT
			dispatch_idx
		FROM
			DISPATCH_ORDER_MAP
		WHERE
			outbound_order_idx = #{outboundOrderIdx}
	</select>
	
	<!-- 배차 상태 취소로 변경 -->
	<update id="updateDispatchStatus">
		UPDATE
			DISPATCH
		SET
			status = #{status}
			, updated_at = NOW()
		WHERE
			dispatch_idx = #{dispatchIdx}
	</update>
	
	<!-- 배차 상태 확인 -->
	<select id="selectDispatchStatus" resultType="string">
		SELECT
			status
		FROM
			DISPATCH
		WHERE
			dispatch_idx = #{dispatchIdx}
	</select>
	
	<!-- 배차 상세 정보(예약 및 취소 상태일 경우)  -->
	<select id="selectDispatchSummary" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_DISPATCH_DETAIL
		WHERE
			dispatch_idx = #{dispatchIdx}
		AND
			vehicle_idx = #{vehicleIdx}
	</select>
	
	<!-- 배차 상제 정보(적재 완료 후) -->
	<!-- 수주 확인서 품목 매핑 -->
	<resultMap id="deliveryConfirmationItemMap" type="com.itwillbs.keanu_coffee.transport.dto.DeliveryConfirmationItemDTO">
	    <id property="confirmationItemIdx" column="confirmation_item_idx"/>
	    <result property="confirmationIdx" column="delivery_confirmation_idx"/>
	    <result property="productIdx" column="product_idx"/>
	    <result property="itemName" column="item_name"/>
	    <result property="orderedQty" column="ordered_qty"/>
	    <result property="deliveredQty" column="delivered_qty"/>
	    <result property="status" column="item_status"/>
	    <result property="note" column="item_note"/>
	</resultMap>
	
	<!-- 수주 확인서 매핑 -->
	<resultMap id="deliveryConfirmationMap" type="com.itwillbs.keanu_coffee.transport.dto.DeliveryConfirmationDTO">
	    <id property="deliveryConfirmationIdx" column="delivery_confirmation_idx"/>
	    <result property="dispatchAssignmentIdx" column="dispatch_assignment_idx"/>
	    <result property="dispatchStopIdx" column="dispatch_stop_idx"/>
	    <result property="outboundOrderIdx" column="outbound_order_idx"/>
	    <result property="confirmationTime" column="confirmation_time"/>
	    <result property="receiverName" column="receiver_name"/>
	    <result property="note" column="note"/>
	
	    <!-- ✅ 하위: 수주확인서 → 품목 리스트 -->
	    <collection property="items" resultMap="deliveryConfirmationItemMap"/>
	</resultMap>
	
	<!-- 경유지 매핑 -->
	<resultMap id="dispatchStopMap" type="com.itwillbs.keanu_coffee.transport.dto.DispatchStopDTO">
	    <id property="dispatchStopIdx" column="dispatch_stop_idx"/>
	    <result property="dispatchIdx" column="dispatch_idx"/>
	    <result property="dispatchAssignmentIdx" column="dispatch_assignment_idx"/>
	    <result property="deliverySequence" column="delivery_sequence"/>
	    <result property="franchiseIdx" column="franchise_idx"/>
	    <result property="franchiseName" column="franchise_name"/>
	    <result property="regionIdx" column="region_idx"/>
	    <result property="regionName" column="common_code_name"/>
	    <result property="status" column="status"/>
	    <result property="arrivalTime" column="arrival_time"/>
	    <result property="completeTime" column="complete_time"/>
	    <result property="note" column="note"/>
	
	    <!-- ✅ 경유지 → 수주확인서 목록 -->
	    <collection property="deliveryConfirmations" resultMap="deliveryConfirmationMap"/>
	</resultMap>
	
	<!-- 최상위 Dispatch 상세 -->
	<resultMap id="dispatchDetailMap" type="com.itwillbs.keanu_coffee.transport.dto.DispatchDetailDTO">
	    <id property="dispatchIdx" column="dispatch_idx"/>
	    <result property="dispatchDate" column="dispatch_date"/>
	    <result property="startSlot" column="start_slot"/>
	    <result property="status" column="status"/>
	    <result property="urgent" column="urgent"/>
	    <result property="vehicleIdx" column="vehicle_idx"/>
	    <result property="vehicleNumber" column="vehicle_number"/>
	    <result property="capacity" column="capacity"/>
	    <result property="driverName" column="driver_name"/>
	    <result property="orderIds" column="order_ids"/>
	    <result property="totalVolume" column="total_volume"/>
	    <result property="totalQty" column="total_qty"/>
	
	    <!-- ✅ Dispatch → 여러 경유지 -->
	    <collection property="franchises" resultMap="dispatchStopMap"/>
	</resultMap>
	<select id="selectDispatchDetail" resultMap="dispatchDetailMap">
	    SELECT
	        d.dispatch_idx
	        , d.dispatch_date
	        , d.start_slot
	        , d.status
	        , d.urgent
	        , v.vehicle_idx
	        , v.vehicle_number
	        , v.capacity
	        , ds.dispatch_stop_idx
	        , ds.delivery_sequence
	        , ds.franchise_idx
	        , f.franchise_name
	        , f.region_idx
	        , c.common_code_name AS region_name
	        , dc.delivery_confirmation_idx
	        , dc.receiver_name
	        , dc.confirmation_time
	        , dc.note
	        , dci.confirmation_item_idx
	        , dci.product_idx
	        , dci.item_name
	        , dci.ordered_qty
	        , dci.delivered_qty
	        , dci.status AS item_status
	    FROM DISPATCH d
	    JOIN DISPATCH_ASSIGNMENT da ON d.dispatch_idx = da.dispatch_idx
	    JOIN VEHICLE v              ON da.vehicle_idx = v.vehicle_idx
	    JOIN DISPATCH_STOP ds       ON d.dispatch_idx = ds.dispatch_idx 
	                               AND da.dispatch_assignment_idx = ds.dispatch_assignment_idx
	    JOIN FRANCHISE f            ON ds.franchise_idx = f.franchise_idx
	    JOIN COMMON_CODE c          ON f.region_idx = c.common_code_idx
	    JOIN DELIVERY_CONFIRMATION dc ON ds.dispatch_stop_idx = dc.dispatch_stop_idx
	    JOIN DISPATCH_STOPDELIVERY_CONFIRMATION_ITEM dci ON dc.delivery_confirmation_idx = dci.confirmation_idx
	    WHERE d.dispatch_idx = #{dispatchIdx}
	      AND da.vehicle_idx = #{vehicleIdx}
	    ORDER BY ds.delivery_sequence, f.franchise_name, dci.item_name
	</select>
	
	<!-- 배차 정보 조회 (차량idx로 조회) -->
	<select id="selectDispatchByVehicleIdx" resultType="DispatchRegionGroupViewDTO">
		SELECT *
		FROM
			V_DISPATCH_DETAIL
		WHERE
			vehicle_idx = #{vehicleIdx}
	</select>
	
	<!-- 마이페이지 배차 상세 정보 조회 --> 
	<resultMap id="DispatchDetailResultMap" type="DispatchDetailDTO"> 
		<!-- 배차 기본정보 --> 
		<id property="dispatchIdx" column="dispatch_idx"/> 
		<result property="dispatchDate" column="dispatch_date"/> 
		<result property="startSlot" column="start_slot"/> 
		<result property="status" column="status"/> 
		<result property="urgent" column="urgent"/> 
		<result property="vehicleIdx" column="vehicle_idx"/> 
		<result property="vehicleNumber" column="vehicle_number"/> 
		<result property="capacity" column="capacity"/> 
		<result property="orderIds" column="order_ids"/> 
		<result property="totalVolume" column="total_volume"/> 
		<result property="totalQty" column="total_qty"/> 
		<collection property="franchises" ofType="DispatchFranchiseDTO"> 
			<id property="franchiseIdx" column="franchise_idx"/> 
			<result property="franchiseName" column="franchise_name"/> 
			<result property="regionIdx" column="region_idx"/> 
			<result property="regionName" column="region_name"/> 
			<result property="franchiseZipcode" column="franchise_zipcode"/> 
			<result property="franchiseAddress1" column="franchise_address1"/> 
			<result property="franchiseAddress2" column="franchise_address2"/> 
			<result property="franchisePhone" column="franchise_phone"/> 
			<result property="franchiseManagerName" column="franchise_manager_name"/> 
			<result property="status" column="franchise_status"/> 
			<collection property="items" ofType="com.itwillbs.keanu_coffee.outbound.dto.OutboundOrderItemDTO"> 
				<id property="outboundOrderItemIdx" column="outbound_order_item_idx"/> 
				<result property="outboundOrderIdx" column="outbound_order_idx"/> 
				<result property="productIdx" column="product_idx"/> 
				<result property="productName" column="product_name"/> 
				<result property="receiptProductIdx" column="receipt_product_idx"/> 
				<result property="quantity" column="quantity"/> 
				<result property="productVolume" column="product_volume"/> 
			</collection> 
		</collection> 
	</resultMap> 
	<select id="selectMyDispatchInfo" resultMap="DispatchDetailResultMap"> 
		SELECT 
			d.dispatch_idx 
			, d.dispatch_date 
			, d.start_slot 
			, d.status 
			, d.urgent 
			, c.common_code_name AS region_name 
			, f.franchise_idx 
			, f.franchise_name 
			, da.driver_idx 
			, e.emp_name AS driver_name 
			, v.vehicle_idx 
			, v.vehicle_number 
			, v.capacity 
			, o.outbound_order_idx 
			, oi.outbound_order_item_idx 
			, p.product_idx 
			, p.product_name 
			, oi.quantity 
			, p.product_volume 
		FROM 
			DISPATCH d 
		JOIN 
			DISPATCH_ASSIGNMENT da 
		ON 
			d.dispatch_idx = da.dispatch_idx 
		JOIN 
			EMPLOYEE_INFO e 
		ON 
			da.driver_idx = e.emp_idx 
		JOIN 
			VEHICLE v 
		ON 
			da.vehicle_idx = v.vehicle_idx 
		JOIN 
			DISPATCH_ORDER_MAP dom 
		ON 
			d.dispatch_idx = dom.dispatch_idx 
		JOIN
			 OUTBOUND_ORDER o 
		ON 
			dom.outbound_order_idx = o.outbound_order_idx 
		JOIN 
			FRANCHISE f 
		ON 
			o.franchise_idx = f.franchise_idx 
		LEFT JOIN 
			COMMON_CODE c 
		ON 
			f.region_idx = c.common_code_idx 
		JOIN 
			OUTBOUND_ORDER_ITEM oi 
		ON 
			o.outbound_order_idx = oi.outbound_order_idx 
		JOIN 
			PRODUCT p 
		ON 
			oi.product_idx = p.product_idx 
		WHERE 
			d.dispatch_idx = #{dispatchIdx} 
		AND 
			da.vehicle_idx = #{vehicleIdx} 
		ORDER BY 
			f.franchise_name, p.product_name 
	</select>
	
	<!-- 배차 배정 테이블 조회 -->
	<select id="selectAssigmentIdx" resultType="int">
		SELECT 
			dispatch_assignment_idx
		FROM
			DISPATCH_ASSIGNMENT
		WHERE
			dispatch_idx = #{dispatchIdx}
		AND
			vehicle_idx = #{vehicleIdx}
			
	</select>
	
	<!-- 경유지 데이터 등록 -->
	<insert id="insertDispatchStop" useGeneratedKeys="true" keyProperty="dispatchStopIdx">
		INSERT INTO DISPATCH_STOP (
			dispatch_idx
			, dispatch_assignment_idx
			, delivery_sequence
			, franchise_idx
			, status
			, urgent
		)
		VALUES (
			#{dispatchIdx}
			, #{dispatchAssignmentIdx}
			, #{deliverySequence}
			, #{franchiseIdx}
			, #{Status}
			, #{urgent}
		)
	</insert>
	
	<!-- 수주확인서 데이터 등록 -->
	<insert id="insertDeliveryConfirmation" useGeneratedKeys="true" keyProperty="deliveryConfirmationIdx">
		INSERT INTO DELIVERY_CONFIRMATION (
			dispatch_assignment_idx
			, dispatch_stop_idx
			, outbound_order_idx
		)
		VALUES (
			#{dispatchAssignmentIdx}
			, #{dispatchStopIdx}
			, #{outboundOrderIdx}
		)
	</insert>
	
	<!-- 수주확인서품목 데이터 등록 -->
	<insert id="insertDeliveryConfirmationItem">
		INSERT INTO DISPATCH_STOPDELIVERY_CONFIRMATION_ITEM (
			confirmation_idx
			, product_idx
			, item_name
			, ordered_qty
		)
		VALUES (
			#{confirmationIdx}
			, #{productIdx}
			, #{itemName}
			, #{orderedQty}
		)
	</insert>
	
	<!-- 출고 주문 테이블 상태 변경 -->
	<update id="updateOutboundOrderStatus" >
		UPDATE 	
			OUTBOUND_ORDER
		SET
			status = #{status}
			, updated_at = NOW()
		WHERE
			outbound_order_idx = #{outboundOrderIdx}
	</update>
</mapper>
